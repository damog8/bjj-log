<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BJJ Training Log</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 0 16px; }
      h1 { margin: 0 0 6px; font-size: 44px; letter-spacing: -0.5px; }
      h2 { margin-top: 26px; }
      .muted { color: #666; font-size: 14px; margin-bottom: 18px; }

      .card { border: 1px solid #e6e6e6; border-radius: 14px; padding: 16px; background: #fff; }
      form { display: flex; gap: 10px; margin: 0 0 12px; }
      input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 10px; }
      button { padding: 12px 16px; font-size: 16px; border-radius: 10px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .error { color: #b00020; margin-top: 8px; min-height: 20px; }
      .ok { color: #0a7a2f; margin-top: 8px; min-height: 20px; }

      ul { list-style: none; padding: 0; margin: 0; }
      li { padding: 10px 0; border-bottom: 1px solid #eee; }
      .msg { display: flex; justify-content: space-between; gap: 12px; }
      .text { font-size: 16px; }
      .time { color: #777; font-size: 12px; white-space: nowrap; }
    </style>
  </head>
  <body>
    <h1>BJJ Training Log</h1>
    <div class="card">
      <form id="log-form">
        <input id="date-input" type="date" />
        <select id="focus-input">
          <option value="">Focus area…</option>
          <option>Guard retention</option>
          <option>Passing</option>
          <option>Sweeps</option>
          <option>Submissions</option>
          <option>Escapes</option>
          <option>Open sparring</option>
        </select>
        <input
          id="notes-input"
          type="text"
          placeholder="One key thing you worked on or learned…"
          required
        />
        <button id="send-btn" type="submit">Log session</button>
      </form>

      <div id="error" class="error"></div>
      <div id="ok" class="ok"></div>
    </div>

    <h2>Sessions</h2>
    <ul id="logs"></ul>

    <script>
      const listEl = document.getElementById("logs");
      const form = document.getElementById("log-form");
      const dateInput = document.getElementById("date-input");
      const focusInput = document.getElementById("focus-input");
      const notesInput = document.getElementById("notes-input");
      const errorEl = document.getElementById("error");
      const okEl = document.getElementById("ok");
      const sendBtn = document.getElementById("send-btn");

      function setError(msg) {
        errorEl.textContent = msg || "";
        okEl.textContent = "";
      }

      function setOk(msg) {
        okEl.textContent = msg || "";
        errorEl.textContent = "";
      }

      function setBusy(busy) {
        sendBtn.disabled = busy;
        notesInput.disabled = busy;
        focusInput.disabled = busy;
        dateInput.disabled = busy;
      }

      async function loadLogs() {
        listEl.innerHTML = "<li class='muted'>Loading…</li>";

        const res = await fetch("/logs");
        if (!res.ok) {
          listEl.innerHTML = "";
          setError("Failed to load sessions.");
          return;
        }

        const data = await res.json();
        listEl.innerHTML = "";

        if (!data.length) {
          listEl.innerHTML = "<li class='muted'>No sessions logged yet.</li>";
          return;
        }

        data.forEach(l => {
          const li = document.createElement("li");

          const wrap = document.createElement("div");
          wrap.className = "msg";

          const left = document.createElement("div");
          left.className = "text";
          left.innerHTML = `<strong>${l.focus}</strong><br>${l.notes}`;

          const right = document.createElement("div");
          right.className = "time";
          right.textContent = l.session_date;

          wrap.appendChild(left);
          wrap.appendChild(right);
          li.appendChild(wrap);
          listEl.appendChild(li);
        });
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setError("");
        setOk("");

        const focus = focusInput.value.trim();
        const notes = notesInput.value.trim();
        const session_date = dateInput.value;

        if (!focus || !notes) {
          setError("Please select a focus area and add notes.");
          return;
        }

        setBusy(true);

        const params = new URLSearchParams({
          focus,
          notes,
        });

        if (session_date) {
          params.append("session_date", session_date);
        }

        const res = await fetch(`/logs?${params.toString()}`, {
          method: "POST"
        });

        setBusy(false);

        if (!res.ok) {
          try {
            const body = await res.json();
            if (body?.detail?.[0]?.msg) {
              setError(body.detail[0].msg);
            } else {
              setError("Failed to save session.");
            }
          } catch {
            setError("Failed to save session.");
          }
          return;
        }

        notesInput.value = "";
        focusInput.value = "";
        dateInput.value = "";

        setOk("Session logged ✔");
        await loadLogs();
        setTimeout(() => setOk(""), 1200);
      });

      loadLogs();
    </script>

  </body>
</html>
